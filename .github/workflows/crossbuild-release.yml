name: Build Cross-Platform Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-release:
    strategy:
      matrix:
        include:
          - os: windows-latest
            python-version: '3.12'
            asset_name: RGO_lib_parser_win64.exe
            build_command: pyinstaller --onefile --windowed --icon="assets/winapp_lilacbook.ico" --add-data "assets/window_bnwbook.png;." --name RGO_lib_parser src/main.py
            asset_path: ./dist/RGO_lib_parser.exe
            asset_content_type: application/vnd.microsoft.portable-executable
          - os: macos-latest
            python-version: '3.12'
            asset_name: RGO_lib_parser_macOS.zip
            build_command: pyinstaller --windowed --icon="assets/macapp_lilacbook.icns" --add-data "assets/window_bnwbook.png:." --name "RGO Lib Parser" src/main.py
            asset_path: ./dist/RGO_lib_parser_macOS.zip
            asset_content_type: application/zip
            post_build_command: zip -r ./dist/RGO_lib_parser_macOS.zip ./dist/"RGO Lib Parser.app"
          - os: ubuntu-latest
            python-version: '3.12'
            asset_name: RGO_lib_parser_ubuntu
            build_command: pyinstaller --onefile --noconsole --add-data "assets/window_bnwbook.png:." --name RGO_lib_parser src/main.py
            asset_path: ./dist/RGO_lib_parser
            asset_content_type: application/octet-stream
            pre_build_command: |
              sudo apt-get update
              sudo apt-get install -y python3-tk

    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        shell: bash # Для совместимости команд

      - name: Install Tkinter (Linux only)
        if: runner.os == 'Linux' && matrix.pre_build_command
        run: ${{ matrix.pre_build_command }}
        shell: bash

      - name: Install dependencies using uv
        run: |
          uv pip install --system .
          uv pip install --system pyinstaller
        shell: bash

      - name: Build with PyInstaller
        run: ${{ matrix.build_command }}
        shell: bash

      - name: Create Zip Archive (macOS only)
        if: runner.os == 'macOS' && matrix.post_build_command
        run: ${{ matrix.post_build_command }}
        shell: bash

      # --- ИСПРАВЛЕННЫЙ ШАГ ДЛЯ WINDOWS ---
      - name: Generate SHA512 Checksum (Windows)
        if: runner.os == 'Windows'
        id: checksum_win
        working-directory: ./dist # Работаем прямо в директории dist
        run: |
          # Получаем только имя файла из полного пути matrix.asset_path
          $fileName = Split-Path -Path "${{ matrix.asset_path }}" -Leaf 
          $checksumFile = "$fileName.sha512"
          
          # Вычисляем хэш SHA512 и берем только значение хэша в нижнем регистре
          $checksumValue = (Get-FileHash -Path $fileName -Algorithm SHA512).Hash.ToLower() 
          
          # Формируем строку в формате "HASH  FILENAME" (два пробела, как у shasum)
          $checksumLine = "$checksumValue  $fileName" # Используем два пробела для совместимости с shasum
          
          # Записываем эту строку в файл .sha512 в кодировке UTF-8 без BOM (по умолчанию для Set-Content в PS Core)
          Set-Content -Path $checksumFile -Value $checksumLine
          
          # Выводим переменные для следующих шагов через GITHUB_OUTPUT
          # Используем Out-File для надежной записи в $env:GITHUB_OUTPUT
          echo "checksum_line=$checksumLine" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "checksum_file=$checksumFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh 
      # --- КОНЕЦ ИСПРАВЛЕННОГО ШАГА ---

      - name: Generate SHA512 Checksum (Linux/macOS)
        if: runner.os != 'Windows'
        id: checksum_nix
        working-directory: ./dist
        run: |
          FILENAME=$(basename "${{ matrix.asset_path }}")
          # shasum генерирует формат "HASH  FILENAME" (с двумя пробелами)
          shasum -a 512 "$FILENAME" > "${FILENAME}.sha512"
          CHECKSUM_LINE=$(cat "${FILENAME}.sha512") 
          CHECKSUM_FILE="${FILENAME}.sha512"
          echo "checksum_line=${CHECKSUM_LINE}" >> $GITHUB_OUTPUT
          echo "checksum_file=${CHECKSUM_FILE}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload Release Asset (${{ matrix.asset_name }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # gh cli может использовать и GH_TOKEN
        run: |
          gh release upload ${{ github.event.release.tag_name }} ${{ matrix.asset_path }} --clobber
        shell: bash

      - name: Upload Checksum File (${{ matrix.asset_name }}.sha512)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Используем || для выбора правильного output из шагов checksum_win или checksum_nix
          CHECKSUM_FILE_OUTPUT="${{ steps.checksum_win.outputs.checksum_file || steps.checksum_nix.outputs.checksum_file }}"
          # Путь к файлу чек-суммы внутри dist
          CHECKSUM_FILE_PATH="./dist/$CHECKSUM_FILE_OUTPUT"
          gh release upload ${{ github.event.release.tag_name }} "$CHECKSUM_FILE_PATH" --clobber
        shell: bash

      - name: Create temporary checksum file for aggregation
        id: create_checksum_file 
        run: |
          # Используем || для выбора правильного output
          CHECKSUM_LINE_OUTPUT="${{ steps.checksum_win.outputs.checksum_line || steps.checksum_nix.outputs.checksum_line }}"
          # Убедимся, что директория существует (на всякий случай)
          mkdir -p ${{ runner.temp }}
          # Записываем строку чек-суммы во временный файл
          echo "$CHECKSUM_LINE_OUTPUT" > ${{ runner.temp }}/checksum_line.txt
        shell: bash

      - name: Store checksum line for aggregation
        uses: actions/upload-artifact@v4
        with:
          name: checksum-line-${{ matrix.os }} # Уникальное имя артефакта для каждой ОС
          path: ${{ runner.temp }}/checksum_line.txt # Путь к файлу для загрузки

  aggregate-checksums:
    name: Aggregate Checksums
    needs: build-release # Запускается после всех build-release джобов
    runs-on: ubuntu-latest
    steps:
      - name: Download all checksum lines
        uses: actions/download-artifact@v4
        with:
          pattern: checksum-line-* # Скачиваем все артефакты, начинающиеся с checksum-line-
          path: checksum-lines # Скачиваем в директорию checksum-lines
          merge-multiple: true # Объединяем содержимое артефактов в одну директорию

      - name: Create aggregated checksums.txt file
        id: aggregate
        run: |
          # Объединяем все .txt файлы из скачанной директории в один сырой файл
          cat checksum-lines/*.txt > checksums_raw.txt
          # Сортируем строки для консистентности
          sort checksums_raw.txt > checksums.txt
          # Создаем финальный файл с заголовком
          echo "Checksums (SHA512) for release ${{ github.event.release.tag_name }}:" > aggregated_checksums.txt
          echo "" >> aggregated_checksums.txt # Пустая строка для разделения
          cat checksums.txt >> aggregated_checksums.txt # Добавляем отсортированные строки
          # Выводим путь к финальному файлу для следующего шага
          echo "checksum_path=aggregated_checksums.txt" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload aggregated checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Загружаем агрегированный файл чек-сумм
          gh release upload ${{ github.event.release.tag_name }} ${{ steps.aggregate.outputs.checksum_path }} --clobber
        shell: bash
