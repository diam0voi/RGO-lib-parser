name: Build Cross-Platform Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-release:
    strategy:
      matrix:
        include:
          - os: windows-latest
            python-version: '3.12'
            asset_name: RGO_lib_parser_win64.exe
            build_command: pyinstaller --onefile --windowed --icon="assets/winapp_lilacbook.ico" --add-data "assets/window_bnwbook.png;." --name RGO_lib_parser src/main.py
            asset_path: ./dist/RGO_lib_parser.exe
            asset_content_type: application/vnd.microsoft.portable-executable
          - os: macos-latest
            python-version: '3.12'
            asset_name: RGO_lib_parser_macOS.zip
            build_command: pyinstaller --windowed --icon="assets/macapp_lilacbook.icns" --add-data "assets/window_bnwbook.png:." --name "RGO Lib Parser" src/main.py
            asset_path: ./dist/RGO_lib_parser_macOS.zip
            asset_content_type: application/zip
            post_build_command: zip -r ./dist/RGO_lib_parser_macOS.zip ./dist/"RGO Lib Parser.app"
          - os: ubuntu-latest
            python-version: '3.12'
            asset_name: RGO_lib_parser_ubuntu
            build_command: pyinstaller --onefile --noconsole --add-data "assets/window_bnwbook.png:." --name RGO_lib_parser src/main.py
            asset_path: ./dist/RGO_lib_parser
            asset_content_type: application/octet-stream
            pre_build_command: | 
              sudo apt-get update
              sudo apt-get install -y python3-tk

    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        shell: bash # Для совместимости команд

      - name: Install Tkinter (Linux only)
        if: runner.os == 'Linux' && matrix.pre_build_command
        run: ${{ matrix.pre_build_command }}
        shell: bash

      - name: Install dependencies using uv
        run: |
          uv pip install --system .
          uv pip install --system pyinstaller
        shell: bash

      - name: Build with PyInstaller
        run: ${{ matrix.build_command }}
        shell: bash

      - name: Create Zip Archive (macOS only)
        if: runner.os == 'macOS' && matrix.post_build_command
        run: ${{ matrix.post_build_command }}
        shell: bash

      - name: Generate SHA512 Checksum (Windows)
        if: runner.os == 'Windows'
        id: checksum_win
        working-directory: ./dist
        run: |
          $filePath = Join-Path -Path "." -ChildPath (Split-Path -Path "${{ matrix.asset_path }}" -Leaf) # Получаем имя файла из matrix.asset_path
          $checksumFile = "$filePath.sha512"
          # Получаем хэш и приводим к нижнему регистру
          $checksumValue = (Get-FileHash -Path $filePath -Algorithm SHA512).Hash.ToLower() 
          # Формируем строку "HASH *FILENAME"
          $checksumLine = "$checksumValue *$filePath"
          # Записываем строку в файл .sha512
          Set-Content -Path $checksumFile -Value $checksumLine
          # Выводим значения
          echo "checksum_line=$checksumLine" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "checksum_file=$checksumFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: Generate SHA512 Checksum (Linux/macOS)
        if: runner.os != 'Windows'
        id: checksum_nix
        working-directory: ./dist
        run: |
          FILENAME=$(basename "${{ matrix.asset_path }}")
          shasum -a 512 "$FILENAME" > "${FILENAME}.sha512"
          CHECKSUM_LINE=$(cat "${FILENAME}.sha512") 
          CHECKSUM_FILE="${FILENAME}.sha512"
          echo "checksum_line=${CHECKSUM_LINE}" >> $GITHUB_OUTPUT
          echo "checksum_file=${CHECKSUM_FILE}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload Release Asset (${{ matrix.asset_name }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} ${{ matrix.asset_path }} --clobber
        shell: bash

      - name: Upload Checksum File (${{ matrix.asset_name }}.sha512)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Используем || для выбора правильного output
          CHECKSUM_FILE_OUTPUT="${{ steps.checksum_win.outputs.checksum_file || steps.checksum_nix.outputs.checksum_file }}"
          gh release upload ${{ github.event.release.tag_name }} ./dist/$CHECKSUM_FILE_OUTPUT --clobber
        shell: bash

      - name: Create temporary checksum file for aggregation
        id: create_checksum_file 
        run: |
          # Используем || для выбора правильного output
          CHECKSUM_LINE_OUTPUT="${{ steps.checksum_win.outputs.checksum_line || steps.checksum_nix.outputs.checksum_line }}"
          # Убедимся, что директория существует (на всякий случай)
          mkdir -p ${{ runner.temp }}
          echo "$CHECKSUM_LINE_OUTPUT" > ${{ runner.temp }}/checksum_line.txt
        shell: bash

      - name: Store checksum line for aggregation
        uses: actions/upload-artifact@v4
        with:
          name: checksum-line-${{ matrix.os }}
          path: ${{ runner.temp }}/checksum_line.txt

  aggregate-checksums:
    name: Aggregate Checksums
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Download all checksum lines
        uses: actions/download-artifact@v4
        with:
          pattern: checksum-line-*
          path: checksum-lines
          merge-multiple: true

      - name: Create aggregated checksums.txt file
        id: aggregate
        run: |
          cat checksum-lines/*.txt > checksums_raw.txt
          sort checksums_raw.txt > checksums.txt
          echo "Checksums (SHA512) for release ${{ github.event.release.tag_name }}:" > aggregated_checksums.txt
          echo "" >> aggregated_checksums.txt
          cat checksums.txt >> aggregated_checksums.txt
          echo "checksum_path=aggregated_checksums.txt" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload aggregated checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} ${{ steps.aggregate.outputs.checksum_path }} --clobber
        shell: bash
